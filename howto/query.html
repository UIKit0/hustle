<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Hustle Query Guide &mdash; Hustle 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Hustle 0.1 documentation" href="../index.html" />
    <link rel="next" title="Inserting Data To Hustle" href="insert.html" />
    <link rel="prev" title="Hustle Schema Design Guide" href="schema.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48426035-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="insert.html" title="Inserting Data To Hustle"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="schema.html" title="Hustle Schema Design Guide"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Hustle 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/hustle.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Hustle Query Guide</a><ul>
<li><a class="reference internal" href="#projections">Projections</a></li>
<li><a class="reference internal" href="#grouping-group-by">Grouping / Group By</a></li>
<li><a class="reference internal" href="#where-clause">Where Clause</a></li>
<li><a class="reference internal" href="#partitions">Partitions</a></li>
<li><a class="reference internal" href="#join-clause">Join Clause</a></li>
<li><a class="reference internal" href="#column-cardinality">Column Cardinality</a></li>
<li><a class="reference internal" href="#order-by-desc-clauses">Order By / Desc Clauses</a></li>
<li><a class="reference internal" href="#limit-distinct-clauses">Limit / Distinct Clauses</a></li>
<li><a class="reference internal" href="#nested-queries">Nested Queries</a></li>
<li><a class="reference internal" href="#select-return-values">select() Return Values</a></li>
<li><a class="reference internal" href="#non-blocking-select">Non-blocking select()</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="schema.html"
                        title="previous chapter">Hustle Schema Design Guide</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="insert.html"
                        title="next chapter">Inserting Data To Hustle</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/howto/query.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="hustle-query-guide">
<span id="queryguide"></span><h1>Hustle Query Guide<a class="headerlink" href="#hustle-query-guide" title="Permalink to this headline">¶</a></h1>
<p>Let&#8217;s take a quick gander at a Hustle query, remember, the query language is Python.  We do some DSL tricks to
make the &#8216;where&#8217; clause especially useful:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">impressions</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span>
       <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="s">&#39;2014-01-22&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">ad_id</span> <span class="o">==</span> <span class="mi">30010</span><span class="p">))</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">h_sum</span><span class="p">(</span><span class="n">pix</span><span class="o">.</span><span class="n">amount</span><span class="p">),</span> <span class="n">h_count</span><span class="p">(),</span>
       <span class="n">where</span><span class="o">=</span><span class="p">((</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="s">&#39;2014-01-13&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">ad_id</span> <span class="o">==</span> <span class="mi">30010</span><span class="p">),</span> <span class="n">pix</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="s">&#39;2014-01-13&#39;</span><span class="p">),</span>
       <span class="n">join</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span> <span class="n">pix</span><span class="o">.</span><span class="n">site_id</span><span class="p">),</span>
       <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="s">&#39;amount&#39;</span><span class="p">),</span>
       <span class="n">desc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
       <span class="n">limit</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<p>Hustle is a relational database, but we reject the SQL language.  The queries are similar to SQL with some
defining differences:</p>
<ul class="simple">
<li>no &#8216;group_by&#8217; clause - if there is an aggregating column, then all other non-aggregating columns are assumed to be &#8216;group_by&#8217; columns</li>
<li>no &#8216;from&#8217; clause - the &#8216;where&#8217; clause lists all of the tables data is queried from</li>
<li>where clauses use binary operators <tt class="docutils literal"><span class="pre">&amp;,</span> <span class="pre">|</span> <span class="pre">and</span> <span class="pre">~</span></tt>.  Note that you will need to parenthesize everything...</li>
<li>joins are not comparisons - unlike SQL, you need to list the join columns, and it uses the equality operator</li>
<li>joins are against exactly two tables - if you need more you can nest queries in the &#8216;where&#8217; clause</li>
<li>extensible, if you don&#8217;t like the built-in aggregating functions, add your own, no worries</li>
<li>limit, desc, distinct, h_sum(), h_avg(), h_count() work as expected</li>
</ul>
<div class="section" id="projections">
<h2>Projections<a class="headerlink" href="#projections" title="Permalink to this headline">¶</a></h2>
<p>The <em>projections</em> are the first list of columns or aggregations in the <a class="reference internal" href="../api/hustle.html#hustle.select" title="hustle.select"><tt class="xref py py-func docutils literal"><span class="pre">select</span></tt></a> function.  The
valid objects here are <a class="reference internal" href="../api/core.html#hustle.core.marble.Column" title="hustle.core.marble.Column"><tt class="xref py py-class docutils literal"><span class="pre">Columns</span></tt></a> and
<a class="reference internal" href="../api/core.html#hustle.core.marble.Aggregation" title="hustle.core.marble.Aggregation"><tt class="xref py py-class docutils literal"><span class="pre">Aggregations</span></tt></a>.  If a column is specified, then the Table that it belongs to
<strong>must</strong> appear in the <em>where</em> parameter.  Similarly, if it is an aggregation function, then the table of the column
being aggregated <strong>must</strong> appear in the <em>where</em> parameter.</p>
<p>As a shortcut, Hustle also provides the <a class="reference internal" href="../api/hustle.html#hustle.star" title="hustle.star"><tt class="xref py py-func docutils literal"><span class="pre">star()</span></tt></a> function that returns a list of all of the
columns of a table.  It is used like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">star</span><span class="p">(</span><span class="n">impressions</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="s">&#39;2014-02-20&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is a list of built-in Hustle functions that return <em>Aggregation</em> objects:</p>
<ul class="simple">
<li><a class="reference internal" href="../api/hustle.html#hustle.h_sum" title="hustle.h_sum"><tt class="xref py py-func docutils literal"><span class="pre">hustle.h_sum()</span></tt></a></li>
<li><a class="reference internal" href="../api/hustle.html#hustle.h_count" title="hustle.h_count"><tt class="xref py py-func docutils literal"><span class="pre">hustle.h_count()</span></tt></a></li>
<li><a class="reference internal" href="../api/hustle.html#hustle.h_avg" title="hustle.h_avg"><tt class="xref py py-func docutils literal"><span class="pre">hustle.h_avg()</span></tt></a></li>
<li><a class="reference internal" href="../api/hustle.html#hustle.h_min" title="hustle.h_min"><tt class="xref py py-func docutils literal"><span class="pre">hustle.h_min()</span></tt></a></li>
<li><a class="reference internal" href="../api/hustle.html#hustle.h_max" title="hustle.h_max"><tt class="xref py py-func docutils literal"><span class="pre">hustle.h_max()</span></tt></a></li>
</ul>
</div>
<div class="section" id="grouping-group-by">
<h2>Grouping / Group By<a class="headerlink" href="#grouping-group-by" title="Permalink to this headline">¶</a></h2>
<p>Hustle has no explicit <em>group by</em> statement.  Instead, if the projection list contains one or more aggregations,
then the <em>rest</em> of the non-aggregating columns are used as the grouping.  Consider the following query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">impressions</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span> <span class="n">h_sum</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">),</span>
       <span class="n">where</span><span class="o">=</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="s">&#39;2014-01-15&#39;</span><span class="p">,</span>
       <span class="n">order_by</span><span class="o">=</span><span class="s">&#39;date&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>if you ran this in the <a class="reference internal" href="cli.html#cliguide"><em>Hustle Command Line Interface (CLI)</em></a>, you might get something like this:</p>
<div class="highlight-python"><div class="highlight"><pre>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
date                       site_id                               sum(cpm_millis)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
2014-01-16                 commodo.com                                       673
2014-01-16                 culpa.com                                       2,522
2014-01-16                 cupidatat.com                                   1,483
2014-01-16                 fugiat.com                                      4,183
2014-01-16                 irure.com                                       3,862
2014-01-16                 minim.com                                       1,652
2014-01-16                 nisi.com                                          136
2014-01-16                 nulla.com                                       1,999
2014-01-16                 tempor.com                                      3,288
2014-01-16                 voluptate.com                                   1,238
2014-01-17                 Lorem.com                                       1,542
2014-01-17                 cillum.com                                      1,115
2014-01-17                 consequat.com                                   1,365
2014-01-17                 dolore.com                                      4,456
2014-01-17                 fugiat.com                                      4,173
2014-01-17                 sint.com                                        3,766
2014-01-17                 sit.com                                         4,376
2014-01-17                 sunt.com                                        2,088
...
</pre></div>
</div>
</div>
<div class="section" id="where-clause">
<h2>Where Clause<a class="headerlink" href="#where-clause" title="Permalink to this headline">¶</a></h2>
<p>The <em>where</em> parameter specifies two important pieces of information:  which tables to fetch data from, and how to
restrict the rows returned from those tables.  If a table is referenced in an expression, then the data from that
table is included in the query.  In this way, Hustle has no need of a redundant <em>from</em> clause, like in SQL.</p>
<p>The <em>where</em> clause is where Hustle&#8217;s column expression DSL comes into play.  The <em>where</em> parameter may be as simple
as a Table instance, or as complex as a list of deeply nested <a class="reference internal" href="../api/core.html#hustle.core.marble.Expr" title="hustle.core.marble.Expr"><tt class="xref py py-class docutils literal"><span class="pre">column</span> <span class="pre">expressions</span></tt></a>.
Consider the following queries:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">q1</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">impressions</span><span class="p">)</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">impressions</span><span class="o">.</span><span class="n">site_id</span> <span class="o">==</span> <span class="s">&#39;google.com&#39;</span><span class="p">)</span>
<span class="n">q3</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">site_id</span> <span class="o">==</span> <span class="s">&#39;google.com&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">cpm_micros</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">q4</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">pixels</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">site_id</span> <span class="o">==</span> <span class="s">&#39;google.com&#39;</span><span class="p">,</span> <span class="n">pixels</span><span class="p">))</span>
</pre></div>
</div>
<p>The first three queries are pretty straightforward, the fourth query is selecting from multiple tables.  Note that this
isn&#8217;t a join, it is simply fetching all <em>dates</em> from <em>impressions</em> for <em>google.com</em> <strong>PLUS</strong> all <em>site_ids</em> from
the <em>pixels</em> table.  The results are simply concatenated, and <em>None</em> values are used where the column doesn&#8217;t exist for
that table.</p>
<p>Where clause also supports <em>in</em> and <em>not in</em> statements by using special operators &#8220;&lt;&lt;&#8221; and &#8220;&gt;&gt;&#8221; respectively:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1005</span><span class="p">])</span>
<span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span> <span class="o">&gt;&gt;</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1005</span><span class="p">])</span>
</pre></div>
</div>
<p>Note that the right value of &#8220;&lt;&lt;&#8221; and &#8220;&gt;&gt;&#8221; could be any type of iterable with each element must be a valid single right value.</p>
</div>
<div class="section" id="partitions">
<h2>Partitions<a class="headerlink" href="#partitions" title="Permalink to this headline">¶</a></h2>
<p>In Hustle, <em>partitions</em> are special columns that allow us to split our data into pieces that group together the same
value for that partition.  When we perform a <em>where</em> expression on the <em>partition</em>, we are able to optimize the
amount of data we consider for the query, thereby vastly improving out query performance.  Currently, Hustle allows
a single partition column per table.</p>
</div>
<div class="section" id="join-clause">
<h2>Join Clause<a class="headerlink" href="#join-clause" title="Permalink to this headline">¶</a></h2>
<p><em>Joins</em> in Hustle are performed by first specifying which tables are to be joined in the <em>where</em> clause (as above),
and by listing the columns to be joined in the <em>join</em> parameter.  Consider the following query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">pixels</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
       <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">site_id</span> <span class="o">==</span> <span class="s">&#39;google.com&#39;</span><span class="p">,</span> <span class="n">pixels</span><span class="o">.</span><span class="n">site_id</span> <span class="o">==</span> <span class="s">&#39;yahoo.com&#39;</span><span class="p">),</span>
       <span class="n">join</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">pixels</span><span class="o">.</span><span class="n">token</span><span class="p">))</span>
</pre></div>
</div>
<p>Here we are selecting one column from each table, restricting both table&#8217;s <em>site_ids</em>, then joining them on their
respective <em>token</em> column.  Joins in Hustle have the following constraints:</p>
<ul class="simple">
<li>join operations are between exactly two tables - to do more, you must <em>nest</em> the queries</li>
<li>both the <em>where</em> and <em>join</em> parameters must be sequences of exactly two elements</li>
<li>currently all joins in Hustle are <a class="reference external" href="http://en.wikipedia.org/wiki/Join_(SQL)#Inner_join">inner joins</a></li>
</ul>
<p>Note that the join argument can also take the name of the column to join on if both tables have the same column name.
The above query could be equivalently written:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">pixels</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
       <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">site_id</span> <span class="o">==</span> <span class="s">&#39;google.com&#39;</span><span class="p">,</span> <span class="n">pixels</span><span class="o">.</span><span class="n">site_id</span> <span class="o">==</span> <span class="s">&#39;yahoo.com&#39;</span><span class="p">),</span>
       <span class="n">join</span><span class="o">=</span><span class="s">&#39;token&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="column-cardinality">
<h2>Column Cardinality<a class="headerlink" href="#column-cardinality" title="Permalink to this headline">¶</a></h2>
<p>Joins are potentially very expensive operations.  It is very important to understand how a join is performed to
ensure that the operation actually completes without stealing all of the resources of your cluster.  The most important
consideration when joining two tables <strong>isn&#8217;t</strong> the size of the tables, it&#8217;s the <em>cardinality</em> of the column you
are joining on.  A column&#8217;s cardinality is the number of unique values it holds.  A column like <em>sex</em> or <em>date</em> or
<em>age</em>, which have very few unique values are said to have <em>low cardinality</em>.  Columns like <em>url</em> or <em>cookie</em> or <em>uid</em>
are said to have <em>high cardinality</em>.</p>
<p>Here are some rules:</p>
<ul class="simple">
<li>join on high cardinality columns</li>
<li>restrict (where clause) on low cardinality columns</li>
<li>always list the table with fewer row first in the <em>join</em> clause</li>
<li>if you need to join on low cardinality tables, try to restrict one table to as few rows as possible, then list that one first in the join</li>
</ul>
</div>
<div class="section" id="order-by-desc-clauses">
<h2>Order By / Desc Clauses<a class="headerlink" href="#order-by-desc-clauses" title="Permalink to this headline">¶</a></h2>
<p>The <em>order_by</em> parameter allows you to sort by any number of columns.  You can control the <em>direction</em> of the sort
using the <em>desc</em> parameter.  The <em>order_by</em> allows many different types of input.  It accepts scalars or sequences,
with any combination of the following types:</p>
<ul class="simple">
<li>a <a class="reference internal" href="../api/core.html#hustle.core.marble.Column" title="hustle.core.marble.Column"><tt class="xref py py-class docutils literal"><span class="pre">column</span></tt></a> means to sort by that column (which should obviously appear in the <em>project</em> list)</li>
<li>a <tt class="xref py py-class docutils literal"><span class="pre">string</span></tt> means to find the first occurrence of the column with that name and sort by it</li>
<li>an <tt class="xref py py-class docutils literal"><span class="pre">int</span></tt> is an index into the <em>project</em> list of columns</li>
</ul>
<p>Here are some examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">))</span>
<span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s">&#39;date&#39;</span><span class="p">)</span>
<span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s">&#39;imps.date&#39;</span><span class="p">)</span>
<span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">))</span>
<span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">h_sum</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that for <em>string</em> style columns, you can use either just the <em>name</em> of the column, or its <em>table.column</em>
notation.</p>
</div>
<div class="section" id="limit-distinct-clauses">
<h2>Limit / Distinct Clauses<a class="headerlink" href="#limit-distinct-clauses" title="Permalink to this headline">¶</a></h2>
<p>The <em>limit</em> and <em>distinct</em> parameters behave much like their SQL counterparts.  Here&#8217;s a few examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="nested-queries">
<h2>Nested Queries<a class="headerlink" href="#nested-queries" title="Permalink to this headline">¶</a></h2>
<p>Hustle allows for arbitrarily nested level of queries, and for the intermediate results to be saved and reused many
times in a session.  This can be useful for getting around Hustle&#8217;s maximum join limit (which is two tables), but also
to perform expensive joins, then reuse them many times.  The <em>nest</em> parameter is used to enable this functionality.</p>
<p>Consider the following queries:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">late_jan_imps</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="s">&#39;2014-01-15&#39;</span><span class="p">,</span> <span class="n">nest</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">select</span><span class="p">(</span><span class="n">late_jan_imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">late_jan_imps</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">select</span><span class="p">(</span><span class="n">late_jan_imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">h_sum</span><span class="p">(</span><span class="n">late_jan_imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<p>Note how we can query once into a temporary table, then query multiple times from this table.  This supports an
exploratory style, where (possibly) expensive queries can be saved and then arbitrarily queried again.</p>
</div>
<div class="section" id="select-return-values">
<h2>select() Return Values<a class="headerlink" href="#select-return-values" title="Permalink to this headline">¶</a></h2>
<p>To facilitate a nice <a class="reference internal" href="cli.html#cliguide"><em>Hustle Command Line Interface (CLI)</em></a> and to have usable results when <em>nesting</em> queries or just processing row oriented
results of a &#8216;normal&#8217; query, the <a class="reference internal" href="../api/hustle.html#hustle.select" title="hustle.select"><tt class="xref py py-func docutils literal"><span class="pre">select</span></tt></a> function will return a number of different results
depending on it&#8217;s parameters.</p>
<ul class="simple">
<li><em>nest=True</em> - will return a <a class="reference internal" href="../api/hustle.html#hustle.Table" title="hustle.Table"><tt class="xref py py-class docutils literal"><span class="pre">Table</span></tt></a></li>
<li><em>dump=True</em> - this is the default in the CLI - will return None, but will dump the result to stdout</li>
<li><em>nest=False, dump=False</em> - this is the default when writing Python programs, and will return an iterator of tuples representing the result</li>
<li><em>nest=True, dump=True</em> - same as <em>nest=True</em> above</li>
</ul>
<p>The idea here is that when in the CLI, you really just want to see the output of your query, while building a program,
you would like to just process the results like a normal
<a class="reference external" href="http://disco.readthedocs.org/en/latest/lib/core.html#disco.core.result_iterator">map/reduce disco job</a>.  Here&#8217;s
an example of processing the results of a query in Python:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">hustle</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">Table</span>
<span class="n">imps</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_tag</span><span class="p">(</span><span class="s">&#39;impressions&#39;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">h_sum</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">cpm_mills</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="p">)</span>
<span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">total</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">date</span><span class="p">,</span> <span class="n">total</span>
</pre></div>
</div>
<p>Also note that it is possible to iterate over all rows in a <cite>Table &lt;hustle.Table&gt;</cite> directly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">hustle</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">Table</span>
<span class="n">imps</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_tag</span><span class="p">(</span><span class="s">&#39;impressions&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">clicks</span><span class="p">,</span> <span class="n">impressions</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">cpm_millis</span> <span class="ow">in</span> <span class="n">imps</span><span class="p">:</span>
  <span class="k">print</span> <span class="n">date</span><span class="p">,</span> <span class="n">clicks</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="../api/hustle.html#hustle.select" title="hustle.select"><tt class="xref py py-func docutils literal"><span class="pre">hustle.select()</span></tt></a></dt>
<dd>Hustle&#8217;s select statement</dd>
</dl>
</div>
</div>
<div class="section" id="non-blocking-select">
<h2>Non-blocking select()<a class="headerlink" href="#non-blocking-select" title="Permalink to this headline">¶</a></h2>
<p>If you want to run multiple queries at the same time, consider using non-blocking select - <tt class="xref py py-func docutils literal"><span class="pre">select_nb</span></tt>. It&#8217;s exactly the same as <a class="reference internal" href="../api/hustle.html#hustle.select" title="hustle.select"><tt class="xref py py-func docutils literal"><span class="pre">select</span></tt></a> except that it returns immediately after submitting query to the cluster. The user can use the return value - a <a class="reference internal" href="../api/hustle.html#hustle.Future" title="hustle.Future"><tt class="xref py py-class docutils literal"><span class="pre">Future</span></tt></a> object to check the query&#8217;s status and fetch its resutls.</p>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">future</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">imps</span><span class="o">.</span><span class="n">ad_id</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">imps</span><span class="o">.</span><span class="n">cpm_millis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">imps</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="s">&#39;2014-01-15&#39;</span><span class="p">,</span> <span class="n">nest</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">future</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s">&#39;active&#39;</span>
<span class="gp">... </span><span class="n">run</span> <span class="n">more</span> <span class="n">queries</span> <span class="n">here</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">future</span><span class="o">.</span><span class="n">done</span>
<span class="gp">&gt;&gt;&gt; </span><span class="bp">False</span>
<span class="gp">... </span><span class="n">do</span> <span class="n">some</span> <span class="n">other</span> <span class="n">things</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">future</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s">&#39;ready&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">future</span><span class="o">.</span><span class="n">done</span>
<span class="gp">&gt;&gt;&gt; </span><span class="bp">True</span>
<span class="gp">... </span><span class="n">wait</span><span class="p">()</span> <span class="n">function</span> <span class="n">gives</span> <span class="n">your</span> <span class="n">results</span> <span class="n">like</span> <span class="n">the</span> <span class="n">select</span><span class="p">()</span> <span class="n">does</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cat</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
<span class="gp">... </span><span class="n">Note</span> <span class="n">that</span> <span class="k">if</span> <span class="n">you</span> <span class="n">call</span> <span class="n">wait</span><span class="p">()</span> <span class="n">on</span> <span class="n">a</span> <span class="n">ongoing</span> <span class="n">query</span><span class="p">,</span> <span class="n">it</span><span class="s">&#39;ll block until it&#39;</span><span class="n">s</span> <span class="n">done</span> <span class="o">...</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><tt class="xref py py-func docutils literal"><span class="pre">hustle.select_nb()</span></tt>
<a class="reference internal" href="../api/hustle.html#hustle.Future" title="hustle.Future"><tt class="xref py py-class docutils literal"><span class="pre">hustle.Future</span></tt></a></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="insert.html" title="Inserting Data To Hustle"
             >next</a> |</li>
        <li class="right" >
          <a href="schema.html" title="Hustle Schema Design Guide"
             >previous</a> |</li>
        <li><a href="../index.html">Hustle 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2014, Tim Spurway.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
<div class="footer">
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>